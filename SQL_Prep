select * from INFORMATION_SCHEMA.COLUMNS

-- Aggregate Crime dataset for the studied period (2010 - 2013)
WITH Crime_Data 
AS 
(
SELECT REPLACE(OFFENSE_CATEGORY_ID, '-', ' ') as OFFENSE_CATEGORY,
COUNT(*) as Count,
CONVERT(date, REPORTED_DATE) as REPORTED_DATE,
YEAR(REPORTED_DATE) as Year,
MONTH(REPORTED_DATE) as Month,
REPLACE(NEIGHBORHOOD_ID, '-', ' ') as NBHD_Name_Crime
FROM crime2010
GROUP BY REPLACE(OFFENSE_CATEGORY_ID, '-', ' '), CONVERT(date, REPORTED_DATE), YEAR(REPORTED_DATE), MONTH(REPORTED_DATE), REPLACE(NEIGHBORHOOD_ID, '-', ' ')

UNION ALL

SELECT REPLACE(OFFENSE_CATEGORY_ID, '-', ' ') as OFFENSE_CATEGORY,
COUNT(*) as Count,
CONVERT(date, REPORTED_DATE) as REPORTED_DATE,
YEAR(REPORTED_DATE) as Year,
MONTH(REPORTED_DATE) as Month,
REPLACE(NEIGHBORHOOD_ID, '-', ' ') as NBHD_Name_Crime
FROM crime2011
GROUP BY REPLACE(OFFENSE_CATEGORY_ID, '-', ' '), CONVERT(date, REPORTED_DATE), YEAR(REPORTED_DATE), MONTH(REPORTED_DATE), REPLACE(NEIGHBORHOOD_ID, '-', ' ')

UNION ALL

SELECT REPLACE(OFFENSE_CATEGORY_ID, '-', ' ') as OFFENSE_CATEGORY,
COUNT(*) as Count,
CONVERT(date, REPORTED_DATE) as REPORTED_DATE,
YEAR(REPORTED_DATE) as Year,
MONTH(REPORTED_DATE) as Month,
REPLACE(NEIGHBORHOOD_ID, '-', ' ') as NBHD_Name_Crime
FROM crime2012
GROUP BY REPLACE(OFFENSE_CATEGORY_ID, '-', ' '), CONVERT(date, REPORTED_DATE), YEAR(REPORTED_DATE), MONTH(REPORTED_DATE), REPLACE(NEIGHBORHOOD_ID, '-', ' ')
)

SELECT OFFENSE_CATEGORY, Year, Month, SUM(Count) as Count, NBHD_Name_Crime
INTO Crime_Data
FROM Crime_Data
WHERE REPORTED_DATE < '2013-01-01'
GROUP BY OFFENSE_CATEGORY, Year, Month, NBHD_Name_Crime
ORDER BY Year, Month


SELECT *
FROM Crime_Data

-- Aggregate crime neighborhood names across the studied period and join them to land trasfer dataset on neighborhood name
SELECT distinct L.NBHD_1 as NBHD_No, L.NBHD_1_CN AS NBHD_Name_Sales, C.NBHD_Name_Crime
FROM Crime_Data C
Full Join Land_Transfer L on L.NBHD_1_CN = C.NBHD_Name_Crime
order by NBHD_No

-- the output is inspected in Excel to match the remaining neighborhood names to produce Neighborhood Mapping Key


-- Join Real Estate Sales data on Crime data using the Neighborhood Mapping Key on Neighborhood ID & Name and on month and year
SELECT *
FROM (SELECT ROW_NUMBER() OVER (ORDER BY NBHD) AS SN, * FROM SalesBook) S
Left join Neighborhood_Mapping M on S.NBHD = CAST(M.NBHD_No AS float)
Inner join Crime_Data C on M.NBHD_Name_Crime = C.NBHD_Name_Crime
	and S.SMONTH = C.Month
	and S.SYEAR = C.Year
ORDER by SN

